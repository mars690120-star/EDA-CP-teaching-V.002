<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藥物治療管理 - SOAP 實作評估考試 (Case 1)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .soap-section {
            transition: all 0.3s ease;
        }
        
        .soap-section:focus-within {
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5), 0 2px 4px -1px rgba(59, 130, 246, 0.06);
            border-color: #3b82f6;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 80px;
        }

        /* 自定義檔案上傳按鈕樣式 */
        .file-upload {
            display: none;
        }
        .custom-file-upload {
            cursor: pointer;
        }

        /* Modal 動畫 */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>
<body class="pb-40">

    <!-- 導航列 -->
    <nav class="bg-blue-900 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold flex items-center">
                <i class="fa-solid fa-hospital-user mr-3"></i>
                <div>
                    <div class="text-sm font-normal opacity-80">E-DA Healthcare Group Clinical Pharmacy Internship Course</div>
                    義大醫療體系醫院臨床藥學實習課程
                </div>
            </h1>
            <div class="text-sm bg-blue-700 px-3 py-1 rounded-full border border-blue-500">
                <span id="status-indicator">考生模式</span>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-5xl" id="exam-content">
        
        <!-- 1. 病人資訊區塊 (題目) -->
        <div id="patient-info-content" class="bg-white rounded-lg shadow-md p-8 mb-8 border-t-8 border-blue-800">
            <div class="flex items-center justify-between mb-6 border-b pb-4">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fa-solid fa-file-medical text-blue-800 mr-2"></i> Case 1: Mr. Jobs
                </h2>
            </div>

            <div class="space-y-4 text-gray-800 leading-relaxed">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-lg">
                    <div>
                        <p><strong class="text-blue-900">Patient:</strong> Mr. Jobs, 72-year-old male</p>
                        <p><strong class="text-blue-900">Height/Weight:</strong> 170 cm, 72 kg (BMI ≈ 24.9)</p>
                        <p><strong class="text-blue-900">Presentation:</strong> Presented to ER with worsening shortness of breath.</p>
                    </div>
                    <div>
                        <p><strong class="text-blue-900">Chief Complaint (CC):</strong> “Doctor, I cannot breathe well and my legs are swelling.”</p>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-blue-900 mt-2">History of Present Illness (HPI):</h3>
                    <p>Patient reports progressive shortness of breath for 2 weeks, worse on exertion. Associated with orthopnea, paroxysmal nocturnal dyspnea, and bilateral leg swelling. Denies chest pain, fever, or cough.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-bold text-blue-900 mt-2">Past Medical History (PMH):</h3>
                        <ul class="list-disc list-inside pl-2">
                            <li>Hypertension ×20 yrs</li>
                            <li>Type 2 Diabetes Mellitus ×15 yrs</li>
                            <li>Chronic Kidney Disease Stage 5 (eGFR 12 mL/min/1.73m², not on dialysis yet)</li>
                            <li>Atrial Fibrillation</li>
                            <li>Dyslipidemia</li>
                            <li>Peptic ulcer disease</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-blue-900 mt-2">Past Surgical History (PSH):</h3>
                        <p>CABG (Coronary artery bypass surgery) 8 years ago</p>
                        
                        <h3 class="font-bold text-blue-900 mt-2">Family/Social History (FH/SH):</h3>
                        <ul class="list-disc list-inside pl-2">
                            <li>Father died of MI at 65</li>
                            <li>Mother had diabetes</li>
                            <li>Ex-smoker 30 pack-years (quit 10 yrs ago)</li>
                            <li>Denies alcohol use</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded border border-gray-200 mt-4">
                    <h3 class="font-bold text-blue-900 border-b pb-1 mb-2">Physical Examination (PE):</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p><strong>Vitals:</strong> BP 160/90 mmHg, HR 98 irregular, RR 24, SpO₂ 90% RA</p>
                            <p><strong>Cardiovascular:</strong> Irregularly irregular rhythm, S3 gallop, mild systolic murmur</p>
                        </div>
                        <div>
                            <p><strong>Respiratory:</strong> Bibasilar crackles</p>
                            <p><strong>Extremities:</strong> Pitting edema +2 bilaterally</p>
                            <p><strong>HEENT:</strong> Mild jugular venous distension at 30° elevation, no thyromegaly or lymphadenopathy</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded border border-gray-200 mt-4">
                    <h3 class="font-bold text-blue-900 border-b pb-1 mb-2">Laboratory Data / Imaging:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p><strong>CBC:</strong> WBC 7,600 / Hb 10.5 g/dL / Plt 170,000</p>
                            <p><strong>BMP:</strong> Na 136, K 5.8, BUN 76, Cr 5.5, Glucose 158 mg/dL</p>
                            <p><strong>HbA1c:</strong> 7.8%</p>
                        </div>
                        <div>
                            <p><strong>INR:</strong> 1.2</p>
                            <p><strong>CXR:</strong> Cardiomegaly, pulmonary congestion</p>
                            <p><strong>EKG:</strong> Atrial fibrillation</p>
                        </div>
                    </div>
                </div>

                <div class="bg-yellow-50 p-4 rounded border border-yellow-200 mt-4">
                    <h3 class="font-bold text-blue-900 border-b border-yellow-200 pb-1 mb-2">Current Medications:</h3>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <li>1. Lisinopril 20 mg QD</li>
                        <li>2. Furosemide 40 mg QD</li>
                        <li>3. Metoprolol succinate 50 mg QD</li>
                        <li>4. Atorvastatin 20 mg QHS</li>
                        <li>5. Dabigatran 150 mg BID</li>
                        <li>6. Metformin 500 mg BID</li>
                        <li>7. Amlodipine 5 mg QD</li>
                        <li>8. Famotidine 20 mg BID</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 2. 學生作答區標題 -->
        <div class="flex items-center mb-4 mt-8">
            <div class="flex-grow h-px bg-gray-300"></div>
            <h2 class="text-2xl font-bold text-blue-800 mx-4 px-4 py-2 bg-white rounded shadow-sm border border-blue-200">
                <i class="fa-solid fa-pen-to-square mr-2"></i> 學生作答區 (Student Response)
            </h2>
            <div class="flex-grow h-px bg-gray-300"></div>
        </div>

        <!-- 作答區塊 Form -->
        <form id="soap-form">
            
            <!-- 學生資訊填寫區 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 border border-gray-200 relative overflow-hidden" id="section-info">
                <div class="absolute top-0 left-0 w-2 h-full bg-orange-500"></div>
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-id-card text-orange-600 mr-2"></i> 學生基本資料 (Student Info)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="input-school" class="block text-sm font-bold text-gray-700 mb-1">學校名稱 (School) <span class="text-red-500">*</span></label>
                        <input type="text" id="input-school" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 transition" placeholder="例如:認真醫學大學">
                    </div>
                    <div>
                        <label for="input-name" class="block text-sm font-bold text-gray-700 mb-1">學生姓名 (Name) <span class="text-red-500">*</span></label>
                        <input type="text" id="input-name" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 transition" placeholder="請輸入姓名">
                    </div>
                    <div>
                        <label for="input-group" class="block text-sm font-bold text-gray-700 mb-1">組別 (Group)</label>
                        <input type="text" id="input-group" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 transition" placeholder="若無分組可不填">
                    </div>
                </div>
            </div>

            <!-- Subjective -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 soap-section border border-gray-200" id="section-s">
                <label for="input-s" class="block text-lg font-bold text-gray-800 mb-2 border-b pb-2 flex justify-between">
                    <div>
                        <span class="text-blue-600 text-2xl mr-1">S</span> 主觀資料 (Subjective)
                        <span class="text-xs text-red-500 font-normal ml-2">*必填</span>
                    </div>
                    <span class="text-xs text-gray-400 font-normal pt-2">請填寫病人主訴及相關症狀</span>
                </label>
                <textarea id="input-s" rows="5" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-gray-800" placeholder="Chief Complain..."></textarea>
            </div>

            <!-- Objective -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 soap-section border border-gray-200" id="section-o">
                <label for="input-o" class="block text-lg font-bold text-gray-800 mb-2 border-b pb-2 flex justify-between">
                    <div>
                        <span class="text-blue-600 text-2xl mr-1">O</span> 客觀資料 (Objective)
                        <span class="text-xs text-red-500 font-normal ml-2">*必填</span>
                    </div>
                    <span class="text-xs text-gray-400 font-normal pt-2">請填寫檢驗數據、相關檢查結果</span>
                </label>
                <textarea id="input-o" rows="5" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-gray-800" placeholder="Lab data, PE findings..."></textarea>
            </div>

            <!-- Assessment -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 soap-section border border-gray-200" id="section-a">
                <label for="input-a" class="block text-lg font-bold text-gray-800 mb-2 border-b pb-2 flex justify-between">
                    <div>
                        <span class="text-blue-600 text-2xl mr-1">A</span> 評估 (Assessment)
                        <span class="text-xs text-red-500 font-normal ml-2">*必填</span>
                    </div>
                    <span class="text-xs text-gray-400 font-normal pt-2">DRP (Drug Related Problems) 評估</span>
                </label>
                <textarea id="input-a" rows="8" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-gray-800" placeholder="Assessment (DRP)..."></textarea>
            </div>

            <!-- Plan -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 soap-section border border-gray-200" id="section-p">
                <label for="input-p" class="block text-lg font-bold text-gray-800 mb-2 border-b pb-2 flex justify-between">
                    <div>
                        <span class="text-blue-600 text-2xl mr-1">P</span> 計畫 (Plan)
                        <span class="text-xs text-red-500 font-normal ml-2">*必填</span>
                    </div>
                    <span class="text-xs text-gray-400 font-normal pt-2">建議治療、監測計畫、衛教</span>
                </label>
                <textarea id="input-p" rows="8" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-gray-800" placeholder="Recommended therapy (Guideline), Goal, Monitor parameter, Patient education..."></textarea>
            </div>

        </form>
    </div>

    <!-- 底部操作列 -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t-2 border-blue-600 shadow-2xl p-3 z-40">
        <div class="container mx-auto max-w-5xl flex flex-col lg:flex-row justify-between items-center gap-3">
            
            <!-- 左側：檔案操作 -->
            <div class="flex gap-2 w-full lg:w-auto overflow-x-auto pb-2 lg:pb-0">
                <button type="button" onclick="downloadDraft()" class="whitespace-nowrap bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded border border-gray-300 flex items-center transition">
                    <i class="fa-solid fa-download mr-2 text-gray-500"></i> 暫存(下載檔案)
                </button>
                
                <label class="whitespace-nowrap custom-file-upload bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded border border-gray-300 flex items-center transition">
                    <input type="file" class="file-upload" id="draft-upload" accept=".json" onchange="uploadDraft(this)"/>
                    <i class="fa-solid fa-upload mr-2 text-gray-500"></i> 匯入暫存檔
                </label>
            </div>
            
            <!-- 右側：完成匯出 -->
            <div class="flex gap-3 w-full lg:w-auto">
                <button type="button" id="btn-export-word" class="flex-1 lg:flex-none bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow-lg transition duration-200 flex items-center justify-center">
                    <i class="fa-solid fa-file-word mr-2"></i> 完成並轉 Word
                </button>

                <button type="button" id="btn-export-pdf" class="flex-1 lg:flex-none bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded shadow-lg transition duration-200 flex items-center justify-center">
                    <i class="fa-solid fa-file-pdf mr-2"></i> 完成並轉 PDF
                </button>
            </div>
        </div>
    </div>

    <!-- 自定義 Modal (取代 alert/confirm) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-96 p-6 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4" id="modal-icon-bg">
                    <i id="modal-icon" class="fa-solid fa-circle-info text-blue-600 text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2" id="modal-title">提示</h3>
                <p class="text-gray-600 mb-6" id="modal-message">訊息內容</p>
                
                <div class="flex justify-center gap-3" id="modal-actions">
                    <!-- 按鈕會由 JS 動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 提示訊息 -->
    <div id="toast" class="toast">訊息提示</div>

    <script>
        // --- 1. Modal & UI 工具 ---

        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalActions = document.getElementById('modal-actions');
        const modalIcon = document.getElementById('modal-icon');
        const modalIconBg = document.getElementById('modal-icon-bg');

        function openModal(title, message, type = 'info', onConfirm = null) {
            modalTitle.innerText = title;
            modalMessage.innerText = message;
            modalActions.innerHTML = ''; // 清空按鈕

            // 設定圖示顏色
            if (type === 'error') {
                modalIcon.className = "fa-solid fa-circle-xmark text-red-600 text-3xl";
                modalIconBg.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4";
            } else if (type === 'confirm') {
                modalIcon.className = "fa-solid fa-circle-question text-yellow-600 text-3xl";
                modalIconBg.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4";
            } else if (type === 'success') {
                modalIcon.className = "fa-solid fa-trophy text-yellow-500 text-3xl";
                modalIconBg.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4";
            } else {
                modalIcon.className = "fa-solid fa-circle-info text-blue-600 text-3xl";
                modalIconBg.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4";
            }

            if (type === 'confirm') {
                // 確認取消按鈕
                const btnCancel = document.createElement('button');
                btnCancel.className = "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded";
                btnCancel.innerText = "取消";
                btnCancel.onclick = closeModal;
                
                const btnConfirm = document.createElement('button');
                btnConfirm.className = "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded";
                btnConfirm.innerText = "確認送出";
                btnConfirm.onclick = () => {
                    closeModal();
                    if (onConfirm) onConfirm();
                };
                
                modalActions.appendChild(btnCancel);
                modalActions.appendChild(btnConfirm);
            } else {
                // 單一關閉按鈕
                const btnOk = document.createElement('button');
                btnOk.className = "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full";
                btnOk.innerText = "確定";
                btnOk.onclick = closeModal;
                modalActions.appendChild(btnOk);
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "toast show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- 2. 驗證邏輯 ---

        function validateForm() {
            // 定義需驗證的欄位
            const sections = [
                { id: 'input-school', name: '學校名稱', container: 'section-info' },
                { id: 'input-name', name: '學生姓名', container: 'section-info' },
                { id: 'input-s', name: '主觀資料 (S)', container: 'section-s' },
                { id: 'input-o', name: '客觀資料 (O)', container: 'section-o' },
                { id: 'input-a', name: '評估 (A)', container: 'section-a' },
                { id: 'input-p', name: '計畫 (P)', container: 'section-p' }
            ];

            for (let section of sections) {
                const element = document.getElementById(section.id);
                if (!element.value.trim()) {
                    openModal('資料未填寫', `錯誤：[${section.name}] 尚未填寫！\n請完成該部分後再送出。`, 'error');
                    
                    const container = document.getElementById(section.container);
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // 視覺提示
                    container.classList.add('ring-4', 'ring-red-300');
                    setTimeout(() => container.classList.remove('ring-4', 'ring-red-300'), 2000);
                    
                    if(element.tagName !== 'DIV') { // Focus if it's an input/textarea
                        element.focus();
                    }
                    
                    return false;
                }
            }
            return true;
        }

        // --- 3. 按鈕事件綁定 ---

        document.addEventListener('DOMContentLoaded', function() {
            loadLocalStorageDraft();

            document.getElementById('btn-export-word').addEventListener('click', function() {
                if (validateForm()) {
                    openModal('確認送出', '確認所有欄位皆已完成並匯出 Word 檔？', 'confirm', exportToWord);
                }
            });

            document.getElementById('btn-export-pdf').addEventListener('click', function() {
                if (validateForm()) {
                    openModal('確認送出', '確認所有欄位皆已完成並匯出 PDF 檔？', 'confirm', exportToPDF);
                }
            });
        });

        // --- 4. 暫存草稿功能 ---

        // 要儲存的所有欄位 ID
        const fieldIds = ['input-school', 'input-name', 'input-group', 'input-s', 'input-o', 'input-a', 'input-p'];

        function getFormData() {
            const data = { timestamp: new Date().toISOString() };
            fieldIds.forEach(id => {
                data[id] = document.getElementById(id).value;
            });
            return data;
        }

        function loadLocalStorageDraft() {
            fieldIds.forEach(id => {
                const val = localStorage.getItem('soap_' + id);
                if(val) document.getElementById(id).value = val;

                // 綁定輸入監聽
                document.getElementById(id).addEventListener('input', function() {
                    localStorage.setItem('soap_' + id, this.value);
                });
            });
        }

        function downloadDraft() {
            const data = getFormData();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "SOAP_Draft_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("草稿檔案已下載！");
        }

        function uploadDraft(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    fieldIds.forEach(id => {
                        if (data[id] !== undefined) {
                            document.getElementById(id).value = data[id];
                            localStorage.setItem('soap_' + id, data[id]);
                        }
                    });

                    showToast("草稿匯入成功！");
                } catch (err) {
                    openModal("錯誤", "檔案格式錯誤，無法讀取。", "error");
                }
            };
            reader.readAsText(file);
            inputElement.value = ''; 
        }

        // --- 5. 匯出實作 ---

        function getFullHtmlContent() {
            // 複製病人資訊區塊的純 HTML，避免 Tailwind 樣式依賴
            const patientInfoElement = document.getElementById('patient-info-content');
            // 注意：這裡直接抓取 innerHTML，在 PDF 生成時我們會重設樣式
            const patientInfoHtml = patientInfoElement.innerHTML;

            const school = document.getElementById('input-school').value;
            const name = document.getElementById('input-name').value;
            const group = document.getElementById('input-group').value;
            const s = document.getElementById('input-s').value.replace(/\n/g, '<br>');
            const o = document.getElementById('input-o').value.replace(/\n/g, '<br>');
            const a = document.getElementById('input-a').value.replace(/\n/g, '<br>');
            const p = document.getElementById('input-p').value.replace(/\n/g, '<br>');
            const dateStr = new Date().toLocaleDateString();

            const groupText = group ? ` / 組別: ${group}` : '';

            // 使用「硬編碼」的內聯樣式 (Inline Styles)，確保 html2canvas 能 100% 抓到顏色
            const titleStyle = "font-size: 24px; color: #1e3a8a; margin: 0; font-weight: bold;";
            const subTitleStyle = "font-size: 16px; color: #555; margin: 5px 0;";
            const h3Style = "font-size: 20px; color: #333; margin: 10px 0;";
            const sectionHeaderStyle = "background-color: #eff6ff; padding: 10px; color: #1e3a8a; border-left: 5px solid #1e3a8a; font-weight: bold; font-size: 18px; margin-top: 20px;";
            const subHeaderStyle = "color: #2563eb; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 16px; margin-top: 15px; margin-bottom: 5px;";
            const contentBoxStyle = "padding: 10px; background-color: #fcfcfc; border: 1px solid #eee; font-size: 14px; line-height: 1.5;";

            // 包裝一個乾淨的 HTML 結構
            return `
                <div style="font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; padding: 40px; color: #000; background-color: #fff;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h1 style="${titleStyle}">義大醫療體系醫院臨床藥學實習課程</h1>
                        <h2 style="${subTitleStyle}">E-DA Healthcare Group Clinical Pharmacy Internship Course</h2>
                        <h3 style="${h3Style}">藥物治療評估 (SOAP) 實務演練 (Case 1)</h3>
                        <p style="margin-top: 10px; font-weight: bold;">
                            學校: ${school} / 姓名: ${name} ${groupText} / 日期: ${dateStr}
                        </p>
                    </div>
                    <hr style="border: 1px solid #ccc;">
                    
                    <!-- 病人資訊 (使用 div 包裹並強制樣式，防止 Tailwind class 失效導致跑版) -->
                    <div style="margin-bottom: 30px; font-size: 14px; line-height: 1.6;">
                        ${patientInfoHtml}
                    </div>

                    <hr style="border: 2px solid #1e3a8a; margin: 20px 0;">
                    <h2 style="${sectionHeaderStyle}">學生作答內容 (Student Response)</h2>
                    
                    <div style="margin-bottom: 15px;">
                        <h3 style="${subHeaderStyle}">Subjective (主觀資料)</h3>
                        <div style="${contentBoxStyle}">${s}</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <h3 style="${subHeaderStyle}">Objective (客觀資料)</h3>
                        <div style="${contentBoxStyle}">${o}</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <h3 style="${subHeaderStyle}">Assessment (評估)</h3>
                        <div style="${contentBoxStyle}">${a}</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <h3 style="${subHeaderStyle}">Plan (計畫)</h3>
                        <div style="${contentBoxStyle}">${p}</div>
                    </div>
                </div>
            `;
        }

        function exportToWord() {
            const content = getFullHtmlContent();
            // Word 不需要太複雜的樣式，使用基本的 html 結構即可
            const preHtml = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>SOAP Export</title></head><body>";
            const postHtml = "</body></html>";
            const html = preHtml + content + postHtml;

            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'SOAP_Case1_Response.doc';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast("Word 檔案已下載");
            setTimeout(() => {
                openModal("恭喜完成", "恭喜您，完成課業了，您最棒了！", "success");
            }, 800);
        }

        function exportToPDF() {
            showToast("正在生成 PDF，請稍候...");
            
            // 1. 強制捲動到頂部，防止截圖空白 (關鍵步驟)
            window.scrollTo(0, 0);

            // 2. 建立容器並填入內容
            const element = document.createElement('div');
            element.innerHTML = getFullHtmlContent();
            
            // 3. 設定容器樣式 - 關鍵修改：
            // 不使用 fixed/absolute 把內容藏在螢幕外，因為那樣容易被瀏覽器優化掉導致空白。
            // 我們使用 z-index 把內容放在底層，但保證它是可見的 (display block)。
            element.style.width = '794px'; // A4 寬度 (約)
            element.style.minHeight = '1123px'; // A4 高度
            element.style.backgroundColor = '#ffffff'; 
            element.style.color = '#000000'; 
            element.style.padding = '0';
            element.style.margin = '0';
            
            // 定位設定：絕對定位於頁面左上角，但層級最低
            element.style.position = 'absolute'; 
            element.style.left = '0';
            element.style.top = '0';
            element.style.zIndex = '-9999'; // 放在最下層
            
            // 4. 掛載到 DOM
            document.body.appendChild(element);
            
            // 5. 等待一下讓瀏覽器渲染圖片和字型
            setTimeout(() => {
                const opt = {
                    margin:       10, // mm
                    filename:     'SOAP_Case1_Response.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true,
                        scrollY: 0, // 強制截圖起點為 0
                        scrollX: 0,
                        windowWidth: 1024, // 模擬桌面寬度
                    },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    // 清理 DOM
                    if(document.body.contains(element)) {
                        document.body.removeChild(element);
                    }
                    
                    showToast("PDF 檔案已下載");
                    setTimeout(() => {
                        openModal("恭喜完成", "恭喜您，完成課業了，您最棒了！", "success");
                    }, 800);
                }).catch(err => {
                    if(document.body.contains(element)) {
                        document.body.removeChild(element);
                    }
                    console.error(err);
                    openModal("錯誤", "PDF 生成失敗，請重試", "error");
                });
            }, 800); // 延遲 800ms 確保渲染完成
        }
    </script>
</body>
</html>